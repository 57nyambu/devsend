<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Templates - DevSend</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">DevSend</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/send">Send Now</a></li>
                    <li class="nav-item"><a class="nav-link" href="/recipients">Recipients</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/templates">Templates</a></li>
                    <li class="nav-item"><a class="nav-link" href="/jobs">Scheduled Jobs</a></li>
                    <li class="nav-item"><a class="nav-link" href="/senders">Senders</a></li>
                    <li class="nav-item"><a class="nav-link" href="/api-keys">API Keys</a></li>
                    <li class="nav-item"><a class="nav-link" href="/logs">Logs</a></li>
                    <li class="nav-item"><a class="nav-link" href="/profile">Profile</a></li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="#" onclick="logout()">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="page-header">
            <div>
                <h1>Email Templates</h1>
                <p class="text-muted mb-0">Create and manage reusable email templates</p>
            </div>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="loadSampleTemplates()">
                    üìã Load Sample Templates
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addModal">
                    + Create Template
                </button>
            </div>
        </div>

        <div class="table-container">
            <div class="mb-3">
                <div class="search-bar">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search templates...">
                </div>
            </div>

        <table class="table" id="templatesTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Subject</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for template in templates %}
                <tr>
                    <td>
                        <strong>{{ template.name }}</strong>
                        {% if template.name.startswith('Sample:') %}
                        <span class="badge bg-info ms-2">Sample</span>
                        {% endif %}
                    </td>
                    <td>{{ template.subject }}</td>
                    <td class="text-muted">{{ template.created_at.strftime('%b %d, %Y') }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="previewTemplate({{ template.id }})">üëÅÔ∏è Preview</button>
                            <button class="btn btn-sm btn-outline-success" onclick="duplicateTemplate({{ template.id }})">üìã Duplicate</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTemplate({{ template.id }})">Delete</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>

    <!-- Add Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Email Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Template Name *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subject Line *</label>
                            <input type="text" class="form-control" name="subject" required>
                            <small class="text-muted">Use {{name}}, {{email}} for placeholders</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Template Type</label>
                            <select class="form-control" id="templateType" onchange="loadTemplateType()">
                                <option value="blank">Blank Template</option>
                                <option value="marketing">Marketing Email</option>
                                <option value="newsletter">Newsletter</option>
                                <option value="promotional">Promotional Offer</option>
                                <option value="transactional">Transactional</option>
                                <option value="welcome">Welcome Email</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Logo URL</label>
                            <input type="text" class="form-control" id="logoUrl" placeholder="https://example.com/logo.png">
                            <small class="text-muted">Your company logo URL (will appear at the top of the email)</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Company/Brand Name</label>
                            <input type="text" class="form-control" id="companyName" placeholder="Your Company">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">HTML Body *</label>
                            <textarea class="form-control" name="html_body" id="html_body" rows="15" required></textarea>
                            <small class="text-muted">Use {{name}}, {{email}}, {{company}}, {{product}}, {{link}} as placeholders</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Text Body</label>
                            <textarea class="form-control" name="text_body" rows="5"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Footer Information</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" class="form-control mb-2" id="companyAddress" placeholder="Company Address">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control mb-2" id="companyPhone" placeholder="Phone Number">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control mb-2" id="companyWebsite" placeholder="Website URL">
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control mb-2" id="unsubscribeLink" placeholder="Unsubscribe Link">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Social Media Links</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" class="form-control mb-2" id="facebookUrl" placeholder="Facebook URL">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control mb-2" id="twitterUrl" placeholder="Twitter URL">
                                </div>
                                <div class="col-md-4">
                                    <input type="text" class="form-control mb-2" id="linkedinUrl" placeholder="LinkedIn URL">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Placeholders (JSON array)</label>
                            <input type="text" class="form-control" name="placeholders" value='["name", "email", "company", "product", "link"]'>
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary" onclick="generateTemplate()">
                                Generate Professional Template
                            </button>
                            <small class="text-muted ms-2">This will create a professional HTML template with your settings</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/app.js"></script>
    <script>
        setupSearch('templatesTable');
        
        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            setLoading(btn, true);
            
            try {
                await apiRequest('/api/templates', 'POST', new FormData(e.target));
                showToast('Template created successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                setLoading(btn, false);
            }
        });

        async function previewTemplate(id) {
            const data = await apiRequest(`/api/templates/${id}`, 'GET');
            const previewWindow = window.open('', 'Template Preview', 'width=800,height=600');
            previewWindow.document.write(`
                <html>
                <head>
                    <title>${data.subject}</title>
                    <style>body { font-family: Arial, sans-serif; padding: 20px; }</style>
                </head>
                <body>
                    <h3>Subject: ${data.subject}</h3>
                    <hr>
                    ${data.html_body}
                </body>
                </html>
            `);
        }

        async function deleteTemplate(id) {
            if (confirmAction('Are you sure you want to delete this template?')) {
                await apiRequest(`/api/templates/${id}`, 'DELETE');
                showToast('Template deleted successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            }
        }

        function loadTemplateType() {
            const type = document.getElementById('templateType').value;
            const templates = getTemplatesByType(type);
            // Don't auto-fill, just make it available for generation
        }

        function generateTemplate() {
            const type = document.getElementById('templateType').value;
            const logoUrl = document.getElementById('logoUrl').value || 'https://via.placeholder.com/150x50?text=Logo';
            const companyName = document.getElementById('companyName').value || '{{company}}';
            const companyAddress = document.getElementById('companyAddress').value || '';
            const companyPhone = document.getElementById('companyPhone').value || '';
            const companyWebsite = document.getElementById('companyWebsite').value || '';
            const unsubscribeLink = document.getElementById('unsubscribeLink').value || '{{unsubscribe_link}}';
            const facebookUrl = document.getElementById('facebookUrl').value;
            const twitterUrl = document.getElementById('twitterUrl').value;
            const linkedinUrl = document.getElementById('linkedinUrl').value;

            let htmlBody = '';
            
            // Professional email wrapper
            const emailHeader = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${companyName}</title>
    <style>
        body { margin: 0; padding: 0; font-family: 'Arial', 'Helvetica', sans-serif; background-color: #f4f4f4; }
        .email-container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
        .header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); padding: 30px 20px; text-align: center; }
        .header img { max-width: 200px; height: auto; }
        .content { padding: 40px 30px; color: #333333; line-height: 1.6; }
        .content h1 { color: #1e40af; font-size: 28px; margin-bottom: 20px; }
        .content h2 { color: #1e40af; font-size: 22px; margin-top: 30px; }
        .content p { font-size: 16px; margin-bottom: 15px; }
        .cta-button { display: inline-block; background: linear-gradient(135deg, #d4af37 0%, #f4d03f 100%); color: #000000; padding: 15px 40px; text-decoration: none; border-radius: 5px; font-weight: bold; margin: 20px 0; box-shadow: 0 4px 6px rgba(212, 175, 55, 0.3); }
        .cta-button:hover { background: linear-gradient(135deg, #b8941f 0%, #d4af37 100%); }
        .highlight-box { background-color: #f0f9ff; border-left: 4px solid #1e40af; padding: 20px; margin: 20px 0; }
        .footer { background-color: #1e293b; color: #ffffff; padding: 30px; text-align: center; }
        .footer p { margin: 5px 0; font-size: 14px; }
        .footer a { color: #d4af37; text-decoration: none; }
        .social-links { margin: 20px 0; }
        .social-links a { display: inline-block; margin: 0 10px; }
        .social-links img { width: 32px; height: 32px; }
        @media only screen and (max-width: 600px) {
            .content { padding: 20px 15px; }
            .content h1 { font-size: 24px; }
            .cta-button { padding: 12px 30px; }
        }
    </style>
</head>
<body>
    <div class="email-container">
        <div class="header">
            <img src="${logoUrl}" alt="${companyName} Logo">
        </div>
        <div class="content">
`;

            const emailFooter = `
        </div>
        <div class="footer">
            ${companyName ? `<p><strong>${companyName}</strong></p>` : ''}
            ${companyAddress ? `<p>${companyAddress}</p>` : ''}
            ${companyPhone ? `<p>Phone: ${companyPhone}</p>` : ''}
            ${companyWebsite ? `<p>Website: <a href="${companyWebsite}">${companyWebsite}</a></p>` : ''}
            ${(facebookUrl || twitterUrl || linkedinUrl) ? `
            <div class="social-links">
                ${facebookUrl ? `<a href="${facebookUrl}"><img src="https://cdn-icons-png.flaticon.com/512/733/733547.png" alt="Facebook"></a>` : ''}
                ${twitterUrl ? `<a href="${twitterUrl}"><img src="https://cdn-icons-png.flaticon.com/512/733/733579.png" alt="Twitter"></a>` : ''}
                ${linkedinUrl ? `<a href="${linkedinUrl}"><img src="https://cdn-icons-png.flaticon.com/512/174/174857.png" alt="LinkedIn"></a>` : ''}
            </div>` : ''}
            <p style="font-size: 12px; color: #94a3b8; margin-top: 20px;">
                This email was sent to {{email}}. If you no longer wish to receive these emails, 
                <a href="${unsubscribeLink}" style="color: #d4af37;">unsubscribe here</a>.
            </p>
            <p style="font-size: 12px; color: #64748b;">¬© ${new Date().getFullYear()} ${companyName}. All rights reserved.</p>
        </div>
    </div>
</body>
</html>
`;

            // Template-specific content
            switch(type) {
                case 'marketing':
                    htmlBody = emailHeader + `
            <h1>Hello {{name}}! üëã</h1>
            <p>We're excited to share something special with you today!</p>
            
            <div class="highlight-box">
                <h2>Why Choose Us?</h2>
                <p>‚úì Industry-leading solutions</p>
                <p>‚úì Trusted by thousands of customers</p>
                <p>‚úì 24/7 dedicated support</p>
                <p>‚úì Proven track record of success</p>
            </div>
            
            <p>We believe in delivering exceptional value to our customers, and we're confident you'll love what we have to offer.</p>
            
            <p style="text-align: center;">
                <a href="{{link}}" class="cta-button">Learn More</a>
            </p>
            
            <p>Have questions? Our team is here to help! Simply reply to this email or contact us anytime.</p>
            
            <p>Best regards,<br>The ${companyName} Team</p>
` + emailFooter;
                    break;

                case 'newsletter':
                    htmlBody = emailHeader + `
            <h1>üì∞ Your Monthly Update</h1>
            <p>Hi {{name}},</p>
            <p>Here's what's new this month at ${companyName}!</p>
            
            <h2>üéØ Feature Highlights</h2>
            <div class="highlight-box">
                <p><strong>New Feature Launch:</strong> We've just released {{product}} - designed to make your life easier.</p>
            </div>
            
            <h2>üìö Latest Blog Posts</h2>
            <p>‚Ä¢ <a href="{{link}}">How to Maximize Your Productivity</a></p>
            <p>‚Ä¢ <a href="{{link}}">Industry Trends You Need to Know</a></p>
            <p>‚Ä¢ <a href="{{link}}">Customer Success Stories</a></p>
            
            <h2>üí° Tips & Tricks</h2>
            <p>Did you know? You can save time by using our advanced features. Check out our <a href="{{link}}">knowledge base</a> for more tips.</p>
            
            <p style="text-align: center; margin-top: 30px;">
                <a href="{{link}}" class="cta-button">Read Full Newsletter</a>
            </p>
            
            <p>Stay tuned for more updates!<br>The ${companyName} Team</p>
` + emailFooter;
                    break;

                case 'promotional':
                    htmlBody = emailHeader + `
            <h1>üéâ Exclusive Offer Just for You!</h1>
            <p>Hi {{name}},</p>
            <p>We're thrilled to offer you an exclusive promotion that you won't want to miss!</p>
            
            <div class="highlight-box" style="text-align: center; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #d4af37;">
                <h2 style="font-size: 32px; margin: 10px 0; color: #92400e;">üî• LIMITED TIME OFFER üî•</h2>
                <p style="font-size: 24px; font-weight: bold; color: #92400e;">Save 50% on {{product}}</p>
                <p style="font-size: 18px; color: #92400e;">Use code: <strong>SAVE50</strong></p>
            </div>
            
            <p><strong>Why act now?</strong></p>
            <p>‚úì Exclusive discount for valued customers<br>
               ‚úì Limited quantities available<br>
               ‚úì Offer expires in 48 hours<br>
               ‚úì Free shipping on all orders</p>
            
            <p style="text-align: center;">
                <a href="{{link}}" class="cta-button" style="font-size: 18px;">Claim Your Discount Now</a>
            </p>
            
            <p style="text-align: center; color: #dc2626; font-size: 14px;">‚è∞ Hurry! Offer ends soon</p>
            
            <p>Don't miss out on this incredible opportunity!<br>The ${companyName} Team</p>
` + emailFooter;
                    break;

                case 'welcome':
                    htmlBody = emailHeader + `
            <h1>Welcome to ${companyName}! üéä</h1>
            <p>Hi {{name}},</p>
            <p>We're absolutely thrilled to have you join our community! Thank you for choosing ${companyName}.</p>
            
            <div class="highlight-box">
                <h2>üöÄ Get Started in 3 Easy Steps:</h2>
                <p><strong>1.</strong> Complete your profile to personalize your experience</p>
                <p><strong>2.</strong> Explore our features and discover what we offer</p>
                <p><strong>3.</strong> Join our community and connect with others</p>
            </div>
            
            <h2>What You Can Expect:</h2>
            <p>‚úì Regular updates and exclusive content<br>
               ‚úì Priority customer support<br>
               ‚úì Access to premium features<br>
               ‚úì Special offers and promotions</p>
            
            <p style="text-align: center;">
                <a href="{{link}}" class="cta-button">Complete Your Profile</a>
            </p>
            
            <p>If you have any questions or need assistance, don't hesitate to reach out. We're here to help!</p>
            
            <p>Welcome aboard!<br>The ${companyName} Team</p>
` + emailFooter;
                    break;

                case 'transactional':
                    htmlBody = emailHeader + `
            <h1>Order Confirmation</h1>
            <p>Hi {{name}},</p>
            <p>Thank you for your order! We're processing it now and will notify you once it ships.</p>
            
            <div class="highlight-box">
                <h2>Order Details</h2>
                <p><strong>Order Number:</strong> #{{order_id}}</p>
                <p><strong>Order Date:</strong> {{date}}</p>
                <p><strong>Product:</strong> {{product}}</p>
                <p><strong>Total:</strong> {{total}}</p>
            </div>
            
            <h2>What's Next?</h2>
            <p>1. You'll receive a shipping confirmation email once your order ships<br>
               2. Track your order anytime using your order number<br>
               3. Contact us if you have any questions</p>
            
            <p style="text-align: center;">
                <a href="{{link}}" class="cta-button">Track Your Order</a>
            </p>
            
            <p>Thank you for your business!<br>The ${companyName} Team</p>
` + emailFooter;
                    break;

                default:
                    htmlBody = emailHeader + `
            <h1>Hello {{name}}!</h1>
            <p>Welcome to our email.</p>
            
            <p>Add your content here...</p>
            
            <p style="text-align: center;">
                <a href="{{link}}" class="cta-button">Take Action</a>
            </p>
            
            <p>Best regards,<br>The ${companyName} Team</p>
` + emailFooter;
            }

            document.getElementById('html_body').value = htmlBody;
            showToast('Professional template generated! You can now customize it further.', 'success');
        }

        function getTemplatesByType(type) {
            // Template definitions for future use
            return {};
        }

        async function loadSampleTemplates() {
            if (!confirmAction('This will create 4 professional sample templates (Marketing, Promotional, Welcome, Newsletter). Continue?')) {
                return;
            }
            
            try {
                await apiRequest('/api/templates/create-samples', 'POST');
                showToast('Sample templates created successfully! Refreshing...', 'success');
                setTimeout(() => location.reload(), 1500);
            } catch (error) {
                // Error already handled by apiRequest
            }
        }

        async function duplicateTemplate(id) {
            try {
                const data = await apiRequest(`/api/templates/${id}`, 'GET');
                
                // Pre-fill the form with template data
                document.querySelector('[name="name"]').value = data.name + ' (Copy)';
                document.querySelector('[name="subject"]').value = data.subject;
                document.getElementById('html_body').value = data.html_body;
                document.querySelector('[name="text_body"]').value = data.text_body || '';
                document.querySelector('[name="placeholders"]').value = data.placeholders || '[]';
                
                // Open modal
                const modal = new bootstrap.Modal(document.getElementById('addModal'));
                modal.show();
                
                showToast('Template loaded for duplication. Modify and save.', 'info');
            } catch (error) {
                // Error already handled
            }
        }
    </script>

    <footer>
        <div class="container">
            <p>Made with <span class="footer-heart">‚ô•</span> by <a href="https://tomnyambu.dev" target="_blank">Tom Nyambu</a></p>
        </div>
    </footer>
</body>
</html>
